!function(){"use strict";angular.module("multiUpload").directive("movable",[function(){return{restrict:"A",scope:{movable:"=",index:"="},require:"^upload",replace:!0,link:function(a,b,c,d){if(a.movable===!0){b.bind("dragenter",function(a){a.preventDefault()}),b.bind("dragleave",function(a){}),b.bind("dragover",function(a){a.preventDefault()}),b.bind("drop",function(b){b.preventDefault(),""!==b.dataTransfer.getData("index")&&a.$apply(function(){d.reorder(b.dataTransfer.getData("index"),a.index)})});var e=angular.element(b[0].querySelector(".desktop"));e.attr("draggable",!0),e.bind("dragstart",function(b){b.dataTransfer.effectAllowed="move",b.dataTransfer.setData("index",a.index)}),e.bind("dragend",function(a){})}}}}])}(),function(){"use strict";angular.module("multiUpload").directive("rule",[function(){return{restrict:"E",scope:!0,require:"^^rules",replace:!0,template:"",link:function(a,b,c,d){var e,f=[];if(angular.forEach(c.$attr,function(b,d){"onError"===d?e=c[d]:f.push({key:d,value:a.$eval(c[d])})}),0===f.length)throw"Bad rule declaration : no rule defined in\n";angular.forEach(f,function(a){d.addRule(a.key,a.value,e)})}}}])}(),function(){"use strict";angular.module("multiUpload").directive("rules",[function(){return{restrict:"E",scope:{accept:"@"},require:"^^upload",replace:!0,template:"",link:function(a,b,c,d){d.addRule(a.accept,a.rules)},controller:["$scope",function(a){a.rules={},this.addRule=function(b,c,d){if(b in a.rules)throw"Same rules declared multiple times : previous declaration of "+b+'="'+a.rules[b].limit+'" /> redeclared here :\n';a.rules[b]={limit:c,onError:d}}}]}}])}(),function(){"use strict";angular.module("multiUpload").directive("topinfo",[function(){return{restrict:"E",scope:{},require:"^upload",replace:!0}}])}(),function(){"use strict";var a={crop:function(a,b,c,d){return a&&d&&(a.cropable=!0),!0},count:function(a,b,c,d){var e,f,g=!1,h=!0,i=a&&d?b.length+1:b.length,j=c.limit,k=parseInt(j,10),l=j.split(",");return""===j||"0"===j?e=f=0:"*"===j||","===j||"."===j?e=f=-1:2===l.length?(e=""===l[0]?-1:parseInt(l[0]),f=""===l[1]?-1:parseInt(l[1]),"NaN"!==e&&"NaN"!==f||(g=!0,console.error("Bad limit value for count : "+j))):"NaN"!==k?e=f=k:(g=!0,console.error("Unhandled limit value for count : "+j)),void 0!==e&&void 0!==f?(e>f&&-1!==f&&(g=!0,console.error("Count minimum limit must be inferior to maximum limit : "+e+">"+f)),i>f&&-1!==f?g=!0:e>i&&-1!==e&&(h=!1)):g=!0,g&&(a&&d&&(a.error.failed=!0,a.error.reason+=" "+c.onError),h=!1),h},thumbnail:function(a,b,c,d){return a&&d&&(a.thumbnailable=!0),!0},validator:function(a,b,c,d){if(!a)return!0;var e=c.limit(a);return e.length>0?(a&&d&&(a.error.failed=!0,a.error.reason=[c.onError].concat(e)),!1):!0}};angular.module("multiUpload").directive("upload",[function(){return{restrict:"E",scope:{url:"@",method:"@",files:"=filesList",validRules:"=",fileOnCancelCB:"=fileOncancel",fileRenderSizeCB:"=fileRenderSize",fileOnProgressCB:"=fileOnprogress",fileUploadError:"@",fileExtensionError:"@",simultaneousMax:"@simultaneous"},transclude:!0,replace:!0,templateProvider:$templateCache.get("upload/directives/upload.directive.html"),link:function(a,b,c){a.dropable="dropable"in c,a.orderable="orderable"in c,a.selectable="selectable"in c,a.allowMultiple="multiple"in c,a.allowDuplicate=!("noDuplicate"in c)},controller:["$scope","Upload",function(b,c){function d(c){var d;for(var e in j)if(j.hasOwnProperty(e)){var f=b.getFilesMatchingRuleExtensions(e,c,!1);for(var g in j[e])if(j[e].hasOwnProperty(g))if(0===f.length){if(a[g](null,[],j[e][g],!1)!==!0)return!1}else for(d=0;d<f.length;d++)if(a[g](f[d],f,j[e][g],!1)!==!0)return!1}var h=b.files;c&&(h=c);var i=0;for(d=0;d<h.length;d++)for(var k in j)if(j.hasOwnProperty(k)){var l=k.split(",");-1!==l.indexOf(h[d].extension)&&i++}return i===h.length}function e(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsDataURL(a.source)}function f(a,c,d){0>d?d=0:d>100&&(d=100),a.progress.value=d,a.progress.status=c,b.fileOnProgressCB?a.progress.message=b.fileOnProgressCB(a.source,c,d):a.progress.message=d+"%"}function g(a){for(var c=0;c<b.files.length;c++){var d=b.files[c];if(d.name===a.name&&d.lastModified===a.lastModified&&d.size===a.size)return!1}return!0}function h(a){a&&a.length&&angular.forEach(a,function(a){var c=a.name.substr((~-a.name.lastIndexOf(".")>>>0)+1).toLowerCase();if(b.allowDuplicate||g(a)){var d={source:a,name:a.name,extension:c,size:a.size,type:a.type,lastModified:a.lastModified,progress:{value:0,status:b.PENDING,message:""},error:{failed:!0,reason:[]},thumbnail:null,thumbnailable:!1,crop:{bounds:{left:0,right:0,top:0,bottom:0},drawable:null},cropable:!1,_upload:null,upload:{code:0,data:null}};b.files.push(d)}})}function i(){b.files&&b.files.length&&angular.forEach(b.files,function(d){if(d.error.failed){var e=b.getFilesMatchingRuleExtensions(b.getRuleExtensionsForFileExtension(d.extension));d.error.failed=!1,d.error.reason=[];var g=b.getRulesForExtension(d.extension);g?angular.forEach(g,function(b,c){a[c](d,e,b,!0)}):(d.error.failed=!0,d.error.reason=b.fileExtensionError),d.thumbnailable&&!d.thumbnail&&b.thumbnail(d,d.source)}b.simultaneousCur<b.simultaneousMax&&d.progress.status===b.PENDING&&!d.error.failed&&(f(d,b.TRANSFERING,0),b.simultaneousCur++,d._upload=c.upload({url:b.url,data:{key:d.source},method:b.method}),d._upload.then(function(a){f(d,b.COMPLETE,100),b.simultaneousCur--,d.upload.data=a.data,d.upload.code=a.status},function(a){f(d,b.ERROR,0),d.error.failed=!0,d.error.reason=b.fileUploadError,b.simultaneousCur--},function(a){f(d,b.TRANSFERING,parseInt(100*a.loaded/a.total))})),b.simultaneousCur>=b.simultaneousMax})}b.PENDING=1,b.TRANSFERING=2,b.COMPLETE=3,b.ERROR=4,b.simultaneousCur=0,b.allowedExtensions="";var j={};this.addRule=function(c,d){if(0===Object.keys(d).length)throw"Bad rules declaration : in "+c+" : zero rule defined\n";angular.forEach(d,function(b,e){if(!(e in a))throw"Bad rule declaration : in "+c+" : unknown rule "+e+"\n";j[c]=d}),b.allowedExtensions+=(""===b.allowedExtensions?"":",")+c},b.validRules.run=d,b.reorder=function(a,c,d){if(d&&d.stopPropagation(),!(0>c||c>=b.files.length)){var e=b.files[c];b.files[c]=b.files[a],b.files[a]=e}},this.reorder=b.reorder,b.getRulesForExtension=function(a){var b;return 0===Object.keys(j).length?b:(b=null,angular.forEach(j,function(c,d){var e=d.split(",");return-1!==e.indexOf(a)?void(b=c):void 0}),b)},b.getRuleExtensionsForFileExtension=function(a){var b;return 0===Object.keys(j).length?b:(b=null,angular.forEach(j,function(c,d){var e=d.split(",");return-1!==e.indexOf(a)?void(b=d):void 0}),b)},b.getFilesMatchingRuleExtensions=function(a,c,d){var e=b.files;if(c&&(e=c),!a)return[];var f=[],g=a.split(",");return angular.forEach(e,function(a){-1===g.indexOf(a.extension)||(d||a.error.failed)&&!d||f.push(a)}),f},b.crop=function(a,c){a.stopPropagation();var d=b.getRulesForExtension(c.extension).crop;e(c,function(a){d.limit(a,c.crop,function(a){a===!0?b.thumbnail(c,c.crop.drawable,!0):b.thumbnail(c,c.source)})})},b.thumbnail=function(a,c,d){if(!a.thumbnailable)return void(a.thumbnail=null);if(d)return void(a.thumbnail=c);var f=b.getRulesForExtension(a.extension).thumbnail;f.limit!==!0?a.thumbnail=f.limit(c):e(a,function(b){a.thumbnail=b})},b.onChanges=function(a,b,c,d,e,f){c&&c.length&&(h(c),i())},b.cancel=function(a,c){c&&c.stopPropagation();var d=b.files[a];b.files.splice(a,1),d.progress.status===b.TRANSFERING?d._upload.abort():i(),b.fileOnCancelCB&&b.fileOnCancelCB(d)},b.$watch("simultaneousCur",function(){b.simultaneousCur<b.simultaneousMax&&i()})}]}}])}(),angular.module("multiUpload").run(["$templateCache",function(a){"use strict";a.put("directives/templates/upload.directive.html",'<div class="upload"\r\n	ngf-drop ngf-drop-disabled="!dropable"\r\n	ngf-multiple="allowMultiple"\r\n	ngf-change="onChanges($files, $file, $newFiles, $duplicateFiles, $invalidFiles, $event)"\r\n	ngf-fix-orientation="true" ngf-stop-propagation="true"\r\n	>\r\n	<div class="topinfo" ng-transclude\r\n		ngf-select ngf-select-disabled="!selectable"\r\n		ngf-multiple="allowMultiple" ngf-accept="\'{{ allowedExtensions }}\'"\r\n		ngf-change="onChanges($files, $file, $newFiles, $duplicateFiles, $invalidFiles, $event)"\r\n		ngf-fix-orientation="true" ngf-stop-propagation="true"\r\n		></div>\r\n	<ul>\r\n		<li class="file" movable="orderable" data-index="$index" ng-class="{\'error\': file.error.failed}" ng-repeat="file in files">\r\n			<div ng-show="orderable" class="grip">\r\n				<div class="desktop"></div>\r\n				<div class="mobile">\r\n					<div class="up" ng-click="reorder($index, $index - 1, $event)"></div>\r\n					<div class="down" ng-click="reorder($index, $index + 1, $event)"></div>\r\n				</div>\r\n			</div>\r\n			<div ng-show="file.thumbnailable" class="thumbnail">\r\n				<img src="{{ file.thumbnail }}" alt="thumbnail {{ file.name }}" />\r\n			</div>\r\n			<div ng-show="file.cropable" class="resize" ng-click="crop($event, file)"></div>\r\n			<div class="name">{{ file.name }}</div>\r\n			<div class="size">{{ fileRenderSizeCB(file.size) }}</div>\r\n			<div class="error" ng-show="file.error.failed" title="{{ file.error.reason }}">{{ file.error.reason }}</div>\r\n			<div class="progression">\r\n				<progress ng-show="!file.error.failed" min="0" value="{{ file.progress.value }}" max="100"></progress>\r\n				<span>{{ file.progress.message }}</span>\r\n			</div>\r\n			<div class="delete" ng-click="cancel($index, $event)"></div>\r\n		</li>\r\n	</ul>\r\n</div>\r\n')}]);